#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/zmk/keys.h>

/ {
    chosen {
        zmk,kscan = &kscan0;       // 矩阵扫描器
        zmk,encoder = &encoder0;   // 旋钮
    };

    // 3×4矩阵（12键）
    kscan0: kscan {
        compatible = "zmk,kscan-gpio-matrix";
        label = "KSCAN_MATRIX";

        row-gpios  // 行引脚：D2、D3、D4
            = <&pro_micro_d2 GPIO_ACTIVE_LOW>
              <&pro_micro_d3 GPIO_ACTIVE_LOW>
              <&pro_micro_d4 GPIO_ACTIVE_LOW>
              ;

        col-gpios  // 列引脚：D5、D6、D7、D8
            = <&pro_micro_d5 GPIO_ACTIVE_LOW>
              <&pro_micro_d6 GPIO_ACTIVE_LOW>
              <&pro_micro_d7 GPIO_ACTIVE_LOW>
              <&pro_micro_d8 GPIO_ACTIVE_LOW>
              ;

        // 矩阵映射（3行4列 → 按键索引0-11）
        matrix-transform = <
            MATRIX_TRANSFORM(3, 4,
                0,  1,  2,  3,    // 第1行
                4,  5,  6,  7,    // 第2行
                8,  9, 10, 11     // 第3行
            )
        >;
    };

    // 独立键（第13键，索引12，引脚D9）
    input_keys: input-keys {
        compatible = "zmk,input-keys";
        label = "INDEPENDENT_KEY";
        key_0: key_0 {
            gpios = <&pro_micro_d9 GPIO_ACTIVE_LOW>;
            linux,code = <KEY_RESERVED>;
        };
    };

    // 旋钮（引脚D10/A相、D13/B相）
    encoder0: encoder {
        compatible = "zmk,encoder";
        label = "ENCODER";
        a-gpios = <&pro_micro_d10 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        b-gpios = <&pro_micro_d13 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        resolution = <4>;  // EC11编码器默认分辨率
    };
};

// 引用Pro Micro NRF52840引脚定义
#include "../pro_micro_nrf52840.dtsi"
